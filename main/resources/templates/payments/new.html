<!DOCTYPE html>
<html lang="hr" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Novo plaćanje</title>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Novo plaćanje</h1>
    </div>

    <!-- Content Row -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Unos novog plaćanja</h6>
                </div>
                <div class="card-body">
                    <form method="post" action="/payments/new">
                        <div class="form-group">
                            <label for="userId">Korisnik</label>
                            <select class="form-control" id="userId" name="userId" required>
                                <option value="">Odaberite korisnika</option>
                                <option th:each="u : ${users}" th:value="${u.id}" th:text="${u.fullName} + ' (' + ${u.meterNumber} + ')'" />
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="billId">Račun (opcionalno)</label>
                            <select class="form-control" id="billId" name="billId">
                                <option value="">Unaprijed uplata (bez računa)</option>
                            </select>
                            <small class="form-text text-muted">Prikazuju se samo neplaćeni ili djelomično plaćeni računi.</small>
                        </div>
                        <div class="form-group">
                            <label for="paymentDate">Datum plaćanja</label>
                            <input type="date" class="form-control" id="paymentDate" name="paymentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="amount">Iznos (KM)</label>
                            <input type="number" class="form-control" id="amount" name="amount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Način plaćanja</label>
                            <select class="form-control" id="paymentMethod" name="paymentMethod" required>
                                <option value="">Odaberite način plaćanja</option>
                                <option value="CASH">Gotovina</option>
                                <option value="BANK_TRANSFER">Bankovni prijenos</option>
                                <option value="CARD">Kartica</option>
                            </select>
                        </div>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-primary">Spremi plaćanje</button>
                        <a href="/payments" class="btn btn-secondary">Odustani</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
(function() {
    const userSelect = document.getElementById('userId');
    const billSelect = document.getElementById('billId');
    function clearBills() {
        billSelect.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Unaprijed uplata (bez računa)';
        billSelect.appendChild(opt);
    }
    async function loadBills(userId) {
        clearBills();
        if (!userId) return;
        try {
            const res = await fetch(`/payments/open-bills?userId=${userId}`);
            if (!res.ok) return;
            const data = await res.json();
            data.forEach(b => {
                const o = document.createElement('option');
                const remaining = (Number(b.remaining) || 0).toFixed(2);
                o.value = b.id;
                o.textContent = `${b.billNumber || ('Račun #' + b.id)} - preostalo ${remaining} KM`;
                billSelect.appendChild(o);
            });
        } catch (e) {
            console.error(e);
        }
    }
    userSelect.addEventListener('change', (e) => {
        loadBills(e.target.value);
    });
})();
</script>
</body>
</html>