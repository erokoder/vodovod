<!DOCTYPE html>
<html lang="hr" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${pageTitle}">Pregled očitanja</title>
</head>
<body>
<div layout:fragment="content">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800" th:text="${pageTitle}">Pregled očitanja</h1>
        <div>
            <a href="/readings" class="btn btn-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Nazad na listu
            </a>
            <a th:href="@{/users/{id}(id=${reading.user.id})}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-person"></i> Korisnik
            </a>
            <!-- Dugme za storniranje, vidljivo samo ako se očitanje može stornirati -->
            <button th:if="${!reading.cancelled and !reading.billGenerated}" 
                    type="button" 
                    class="btn btn-danger btn-sm" 
                    data-bs-toggle="modal" 
                    data-bs-target="#cancelModal">
                <i class="bi bi-x-circle"></i> Storniraj
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Osnovni podaci</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">ID</div>
                        <div class="col-sm-8" th:text="${reading.id}">1</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Korisnik</div>
                        <div class="col-sm-8">
                            <a th:href="@{/users/{id}(id=${reading.user.id})}" th:text="${reading.user.fullName}">Ime Prezime</a>
                            <small class="text-muted" th:if="${reading.user.meterNumber}">(<span th:text="${reading.user.meterNumber}"></span>)</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Datum očitanja</div>
                        <div class="col-sm-8" th:text="${#temporals.format(reading.readingDate, 'dd.MM.yyyy')}">01.01.2025</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Prethodno stanje</div>
                        <div class="col-sm-8 text-right" th:text="${#numbers.formatDecimal(reading.previousReadingValue, 1, 3) + ' m³'}">0,000 m³</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Novo stanje</div>
                        <div class="col-sm-8 text-right" th:text="${#numbers.formatDecimal(reading.readingValue, 1, 3) + ' m³'}">0,000 m³</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Potrošnja</div>
                        <div class="col-sm-8 text-right" th:text="${#numbers.formatDecimal(reading.consumption, 1, 3) + ' m³'}">0,000 m³</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Račun generiran</div>
                        <div class="col-sm-8">
                            <span th:if="${reading.billGenerated}" class="badge badge-success">DA</span>
                            <span th:unless="${reading.billGenerated}" class="badge badge-secondary">NE</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Status</div>
                        <div class="col-sm-8">
                            <span th:if="${reading.cancelled}" class="badge badge-danger">STORNIRANO</span>
                            <span th:unless="${reading.cancelled}" class="badge badge-success">AKTIVNO</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Dodatne informacije</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Adresa</div>
                        <div class="col-sm-8" th:text="${reading.user.address != null ? reading.user.address : '—'}">—</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Kontakt</div>
                        <div class="col-sm-8">
                            <span th:text="${reading.user.phoneNumber != null ? reading.user.phoneNumber : '—'}">—</span>
                            <span class="text-muted" th:if="${reading.user.email}"> · <span th:text="${reading.user.email}"></span></span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Unio</div>
                        <div class="col-sm-8" th:text="${reading.createdBy != null ? reading.createdBy : '—'}">—</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Kreirano</div>
                        <div class="col-sm-8" th:text="${reading.createdAt != null ? #temporals.format(reading.createdAt, 'dd.MM.yyyy HH:mm') : '—'}">—</div>
                    </div>
                    <div class="row" th:if="${!reading.cancelled}">
                        <div class="col-sm-4 text-muted">Napomene</div>
                        <div class="col-sm-8">
                            <pre class="mb-0" style="white-space: pre-wrap;" th:text="${reading.notes != null ? reading.notes : '—'}">—</pre>
                        </div>
                    </div>
                    <!-- Informacije o storniranju -->
                    <div th:if="${reading.cancelled}">
                        <div class="row mb-3">
                            <div class="col-sm-4 text-muted">Stornirao</div>
                            <div class="col-sm-8" th:text="${reading.cancelledBy != null ? reading.cancelledBy : '—'}">—</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4 text-muted">Stornirano</div>
                            <div class="col-sm-8" th:text="${reading.cancelledAt != null ? #temporals.format(reading.cancelledAt, 'dd.MM.yyyy HH:mm') : '—'}">—</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4 text-muted">Razlog storniranja</div>
                            <div class="col-sm-8">
                                <pre class="mb-0" style="white-space: pre-wrap;" th:text="${reading.cancellationReason != null ? reading.cancellationReason : '—'}">—</pre>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4 text-muted">Napomene</div>
                            <div class="col-sm-8">
                                <pre class="mb-0" style="white-space: pre-wrap;" th:text="${reading.notes != null ? reading.notes : '—'}">—</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Korisnik</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2"><strong th:text="${reading.user.fullName}">Ime Prezime</strong></div>
                    <div class="text-muted small">Broj vodomjera: <span th:text="${reading.user.meterNumber != null ? reading.user.meterNumber : '—'}">—</span></div>
                    <div class="text-muted small">Adresa: <span th:text="${reading.user.address != null ? reading.user.address : '—'}">—</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal za storniranje -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelModalLabel">Storniranje očitanja</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{/readings/{id}/cancel(id=${reading.id})}" method="post">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>Upozorenje:</strong> Storniranje očitanja će uticati na sva sljedeća očitanja za ovog korisnika. 
                            Potrošnja će biti preračunata za sva sljedeća očitanja.
                        </div>
                        <div class="mb-3">
                            <label for="reason" class="form-label">Razlog storniranja *</label>
                            <textarea class="form-control" id="reason" name="reason" rows="3" 
                                      placeholder="Unesite razlog storniranja..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <strong>Podaci o očitanju:</strong><br>
                            <small class="text-muted">
                                Korisnik: <span th:text="${reading.user.fullName}"></span><br>
                                Datum: <span th:text="${#temporals.format(reading.readingDate, 'dd.MM.yyyy')}"></span><br>
                                Vrijednost: <span th:text="${#numbers.formatDecimal(reading.readingValue, 1, 3) + ' m³'}"></span>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Otkaži</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-x-circle"></i> Storniraj očitanje
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>